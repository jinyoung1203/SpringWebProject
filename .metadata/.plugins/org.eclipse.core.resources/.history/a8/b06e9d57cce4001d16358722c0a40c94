<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">

<title>safd</title>
<meta content="" name="description">
<meta content="" name="keywords">

<!-- Google Fonts -->
<link href="https://fonts.gstatic.com" rel="preconnect">
<link
	href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
	rel="stylesheet">

<!-- Vendor CSS Files -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
	crossorigin="anonymous">
<link
	href="${pageContext.request.contextPath}/resources/assets/vendor/bootstrap-icons/bootstrap-icons.css"
	rel="stylesheet">

<!-- Template Main CSS File -->
<link
	href="${pageContext.request.contextPath}/resources/assets/css/style.css"
	rel="stylesheet">
<script>
	window.onload = function() {
		var url = "preorder.do";
		var param = "amount=0&product_preorder_idx=0";
		sendRequest(url, param, resFn, "get");
	}
function resFn() {
	if (xhr.readyState == 4 && xhr.status == 200) {
	}
}
	$('.naming').each(function(){
		var url = "producer_name.do";
		var param="producer_idx"+${this}.html();
		sendRequest(url,param,resFn2,"get");
	})
	function resFn2(){
		if (xhr.readyState == 4 && xhr.status == 200) {
			${this}.html=xhr.responseText;
		}
	}
	function amount(button, fun) {
		var amount= $(button).siblings('.amount');
		var price = $(button).closest('tr').find('.price');
		let res = amount.innerHTML;
		let minprice= price.innerHTML/res;
		if (fun == '+' && res < 100)
			res++;
		else if (fun == '-' && res > 1)
			res--;
		amount.innerHTML = res;
		price.innerHTML = res * min;
	}
	$('.card').each(function(){
		var price = 0;
		$(this).find('.price').each(function(){
			price+=parseInt($(this).html());
		})
		$(this).find('.totPrice').html(price);
		$(this).find('.movecost')(function(){
			price+=parseInt($(this).html());
		})
		$(this).find('.totalPrice').html(price);
	})
	// 페이지 로딩이 완료된 후 실행될 함수
$(document).ready(function() {
  // .card 요소의 .totalPrice 값을 초기화합니다.
  $('.card').each(function() {
    var price = 0;
    $(this).find('.price').each(function() {
      price += parseInt($(this).html());
    });
    $(this).find('.totPrice').html(price);
	$(this).find('.movecost')(function(){
		price+=parseInt($(this).html());
	})
    $(this).find('.totalPrice').html(price);
  });

  // .price 값이 변경될 때마다 .totalPrice 값을 갱신합니다.
  $('.price').on('change', function() {
    var price = 0;
    $(this).closest('.card').find('.price').each(function() {
      price += parseInt($(this).html());
    });
    $(this).find('.totPrice').html(price);
    if(price!=0){
		$(this).find('.movecost')(function(){
			price+=parseInt($(this).html());
		})
    }
    $(this).closest('.card').find('.totalPrice').html(price);
  });
});
</script>
</head>
<body>
	<h1 style="text-align: center">장바구니</h1>
	<c:set var="producers" value="null"></c:set>
	<c:forEach var="product" items="${preorder_list}">
		<c:if test="${product.producer_idx ne producers}">
			<c:set var="producers" value="${product.producer_idx}"></c:set>
			<div class="card">
				<div class="card-body">
					<div class="naming">${producers}</div>
					<br>
					<c:forEach var="preorder" items="${preorder_list}">
						<c:if test="${preorder.producer_idx eq producers}">
							<table>
								<tr>
									<td rowspan="2">
										<div class="form-check">
											<input class="form-check-input" type="checkbox" value=""
												 checked>
											
										</div>
									</td>
									<td rowspan="2"><a href="#"><img src="#"></a></td>
									<td>${preorder.product_name}</td>
									<td><img src="#" onclick=""></td>
								</tr>

								<tr>
									<td>
										<div class="btn-group col-12" role="group">
											<button type="button" class="btn btn-outline-primary col-3"
												onclick="amount(this, '-');">-</button>
											<button type="button"
												class="btn btn-outline-primary col-6 disabled amount">1</button>
											<button type="button" class="btn btn-outline-primary col-3"
												onclick="amount(this, '+');">+</button>
										</div>
									</td>
									<td><div>
											<span class="price">${preorder.product_price}</span>원
										</div></td>
								</tr>

							</table>
						</c:if>
					</c:forEach>
					<table>
						<tr>
							<td>상품금액</td>
							<td class="totPrice"></td>
						</tr>
						<tr>
							<td>즉시 할인 금액</td>
							<td>0</td>
						</tr>
						<tr>
							<td>배송비</td>
							<td class="movecost">3000</td>
						</tr>
						<tr>
							<td>총 금액</td>
							<td class="totalPrice"></td>
						</tr>
					</table>

				</div>
			</div>

		</c:if>
	</c:forEach>
	<!-- Vendor JS Files -->
	<script
		src="${pageContext.request.contextPath}/resources/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
</body>
</html>